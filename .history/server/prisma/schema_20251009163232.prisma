generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int             @id @default(autoincrement())
  name           String
  email          String          @unique
  googleId       String?         @map("google_id")
  isGuest        Boolean         @map("is_guest")
  role           UserRole        @default(customer)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  orders         Order[]
  cateringOrders CateringOrder[]
  reviews        Review[]
}

enum UserRole {
  customer
  employee
  manager
  admin
}

model Menu {
  id           Int       @id @default(autoincrement())
  name         String
  serviceDay   Int
  weekOf       DateTime?             // NEW: Monday (or Sunday) for that week; null = template
  isTemplate   Boolean   @default(true)   // NEW: template flag
  isActive     Boolean   @default(true)
  displayOrder Int       @default(0)

  items        MenuItem[]

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt      @map("updated_at")

  @@index([serviceDay, weekOf])
  @@unique([serviceDay, isTemplate])      // exactly one template per weekday
  // (Remove @@unique([serviceDay]) if you had it before)
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String     @unique // e.g., "Appetizers", "Entrees", "Naan Breads", "Desserts", "Drinks"
  menuItems MenuItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model MenuItem {
  id             Int              @id @default(autoincrement())
  menuId         Int              @map("menu_id")
  categoryId     Int?             @map("category_id")
  name           String
  description    String?
  imageUrl       String?          @map("image_url")
  menu           Menu             @relation(fields: [menuId], references: [id])
  category       Category?        @relation(fields: [categoryId], references: [id])
  variants       MenuVariant[]
  orderItems     OrderItem[]
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  addOns         AddOn[]          @relation("MenuItemAddOns")
  menuItemAddOns MenuItemAddOns[]

  // Back‑relation for WeeklyDayItem.menuItem
  weeklyDayItems WeeklyDayItem[] // NEW
}

model AddOn {
  id             Int              @id @default(autoincrement())
  name           String
  description    String?
  priceCents     Int              @map("price_cents")
  imageUrl       String?          @map("image_url")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  menuItems      MenuItem[]       @relation("MenuItemAddOns") // Link back to main items
  menuItemAddOns MenuItemAddOns[]
}

// Explicit many-to-many relation table
model MenuItemAddOns {
  menuItemId Int
  addOnId    Int

  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
  addOn    AddOn    @relation(fields: [addOnId], references: [id])

  @@id([menuItemId, addOnId])
}

model MenuVariant {
  id         Int      @id @default(autoincrement())
  menuItemId Int      @map("menu_item_id")
  label      String
  priceCents Int      @map("price_cents")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
}

model WeeklyDay {
  id        Int             @id @default(autoincrement())
  weekOf    DateTime // Monday (or ISO anchor) at 12:00 UTC, see note below
  label     String? // "Mon", "Tue", or custom
  date      DateTime        @unique // the calendar day (store at 12:00 UTC)
  active    Boolean         @default(true)
  items     WeeklyDayItem[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([weekOf])
}

model WeeklyDayItem {
  id          Int       @id @default(autoincrement())
  weeklyDayId Int
  menuItemId  Int
  weeklyDay   WeeklyDay @relation(fields: [weeklyDayId], references: [id])
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])

  @@unique([weeklyDayId, menuItemId])
  @@index([menuItemId])
}

model Order {
  id                    Int          @id @default(autoincrement())
  userId                Int?         @map("user_id")
  status                OrderStatus
  totalCents            Int          @map("total_cents")
  refundedCents         Int          @default(0) @map("refunded_cents")
  fulfillment           Fulfillment
  deliveryDate          DateTime?    @map("delivery_date")
  deliverySlot          String?      @map("delivery_slot")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  user                  User?        @relation(fields: [userId], references: [id])
  orderItems            OrderItem[]
  addOns                OrderAddOn[]
  address               String?
  phone                 String?
  customerEmail         String?
  customerName          String?
  stripePaymentIntentId String?
  emailSentAt           DateTime?    @map("email_sent_at")

  delivery Delivery?
  payment  Payment?
  reviews  Review[]

  // Back‑relation for DeliveryGroup.order
  deliveryGroups DeliveryGroup[] // NEW
}

model OrderItem {
  id              Int  @id @default(autoincrement())
  orderId         Int  @map("order_id")
  menuItemId      Int  @map("menu_item_id")
  quantity        Int
  priceCents      Int  @map("price_cents")
  deliveryGroupId Int? @map("delivery_group_id") // NEW

  order         Order          @relation(fields: [orderId], references: [id])
  menuItem      MenuItem       @relation(fields: [menuItemId], references: [id])
  deliveryGroup DeliveryGroup? @relation(fields: [deliveryGroupId], references: [id])

  @@index([orderId])
  @@index([deliveryGroupId]) // NEW
}

model OrderAddOn {
  id         Int    @id @default(autoincrement())
  orderId    Int
  name       String
  quantity   Int
  priceCents Int

  order Order @relation(fields: [orderId], references: [id])
}

model CateringOrder {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  eventDate       DateTime       @map("event_date")
  guestCount      Int            @map("guest_count")
  specialRequests String?        @map("special_requests")
  status          OrderStatus
  totalCents      Int            @map("total_cents")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  user            User           @relation(fields: [userId], references: [id])
  items           CateringItem[]
}

model CateringItem {
  id              Int           @id @default(autoincrement())
  cateringOrderId Int           @map("catering_order_id")
  name            String
  quantity        Int
  priceCents      Int           @map("price_cents")
  cateringOrder   CateringOrder @relation(fields: [cateringOrderId], references: [id])
}

model Delivery {
  id       Int    @id @default(autoincrement())
  orderId  Int    @unique @map("order_id") // <-- add @unique here
  address  String
  city     String
  state    String
  zip      String
  distance Float
  feeCents Int    @map("fee_cents")
  order    Order  @relation(fields: [orderId], references: [id])
}

model DeliveryGroup {
  id          Int         @id @default(autoincrement())
  orderId     Int         @map("order_id")
  serviceDate DateTime    @map("service_date")
  slot        String?
  order       Order       @relation(fields: [orderId], references: [id])
  items       OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([serviceDate])
}

model DeliverySettings {
  id             Int      @id @default(1)
  originAddress  String
  originLat      Float?
  originLng      Float?
  maxRadiusMiles Float    @default(15)
  // [{ "toMiles": 5, "feeCents": 500 }, { "toMiles": 10, "feeCents": 1000 }, ...]
  feeTiers       Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model SlotTemplate {
  id        Int      @id @default(autoincrement())
  label     String // "5:00 PM"
  startMin  Int // minutes from midnight (e.g., 17*60 for 5:00 PM)
  endMin    Int // optional, but nice for future windows
  capacity  Int      @default(6) // max orders per slot
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlackoutDate {
  id        Int      @id @default(autoincrement())
  date      DateTime // date-only semantics (store start-of-day UTC)
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
}

model Payment {
  id             Int      @id @default(autoincrement())
  orderId        Int      @unique @map("order_id") // <-- add @unique here
  stripeChargeId String?  @map("stripe_charge_id")
  amountCents    Int      @map("amount_cents")
  method         String
  status         String
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  order          Order    @relation(fields: [orderId], references: [id])
}

model InventoryItem {
  id           Int       @id @default(autoincrement())
  supplierId   Int?      @map("supplier_id")
  name         String
  quantity     Int
  unit         String?
  reorderLevel Int       @map("reorder_level")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
}

model Supplier {
  id          Int             @id @default(autoincrement())
  name        String
  contactName String?         @map("contact_name")
  email       String?
  phone       String?
  address     String?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  inventory   InventoryItem[]
}

model Promotion {
  id            Int       @id @default(autoincrement())
  code          String    @unique
  description   String?
  discountCents Int       @map("discount_cents")
  active        Boolean   @default(true)
  startsAt      DateTime  @map("starts_at")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  orderId   Int?     @map("order_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id])
  order     Order?   @relation(fields: [orderId], references: [id])
}

enum MenuType {
  weekly
  everyday
  special
}

enum OrderStatus {
  pending
  confirmed
  preparing
  out_for_delivery
  completed
}

enum Fulfillment {
  delivery
  pickup
}
